<?php

namespace App\Http\Controllers;

use App\Models\User;
use App\Models\Exercise;
use Illuminate\Http\Request;
use App\Models\Subexercise;
use Illuminate\Support\Facades\Storage;
use App\Models\Challenge;


use Hash;

class AdminController extends Controller
{
    public function list()
    {
        $data['header_title'] = 'Admin List';
        $data['getRecord'] = User::getStudent();
        return view('admin.admin.list', $data);
    }

    public function add()
    {
        $data['header_title'] = 'Add New Admin';

        return view('admin.admin.add', $data);
    }
    public function exercise()
    {
        $data['header_title'] = 'Add Exercise';
        $data['getRecord'] = Exercise::getExercise();
        return view('admin.exercise', $data);
    }
    public function edit_exercise($id)
    {
        $data['header_title'] = 'Edit Exercise';
        $data['getRecord'] = Exercise::getExerciseid($id);
        return view('admin.editexercise', $data);
    }

    public function student_exercise($id)
    {
        $data['header_title'] = 'Submit of Student';
        $data['getRecord'] = Subexercise::getStudentid($id);
        return view('admin.studentexercise', $data);
    }
    public function downloadexercise($file_path)
    {
        $filePath = storage_path('app/' . $file_path);
        // Kiểm tra xem tệp có tồn tại không
        if (Storage::exists($file_path)) {
            // Tải tệp về và xác định tên của nó khi tải về
            return response()->download($filePath);
        } else {
            // Xử lý khi tệp không tồn tại
            return response()->json(['message' => 'Tệp không tồn tại'], 404);
        }
    }
    public function update_exercise($id, Request $request)
    {
        $data['header_title'] = 'Update Exercise';
        $exercise = Exercise::find($id);
        if ($request->hasFile('fileToUpload')) {
            $fileExtension = $request->file('fileToUpload')->getClientOriginalExtension();
            $fileName = pathinfo($request->file('fileToUpload')->getClientOriginalName(), PATHINFO_FILENAME);
            $fileNameToStore = $fileName . '_' . time() . '.' . $fileExtension;
            $filePath = $request->file('fileToUpload')->storeAs('uploads/exercises', $fileNameToStore);

            $exercise->title = $request->title;
            $exercise->description = $request->description;
            $exercise->file_path = 'uploads/exercises/' . $fileNameToStore;
            $exercise->save();
        }
        $data['getRecord'] = Exercise::getExercise();
        return view('admin.exercise', $data);
    }

    public function delete_exercise($id)
    {
        $exercise = Exercise::find($id);
        if (!$exercise) {
            return redirect()->back()->with('error', 'Tin nhắn không tồn tại');
        }

        $exercise->delete();

        return redirect()->back()->with('success', 'Tin nhắn đã được xóa');
    }
    public function add_exercise(Request $request)
    {
        $data['header_title'] = 'Add Exercise';
        if ($request->hasFile('fileToUpload')) {
            $fileExtension = $request->file('fileToUpload')->getClientOriginalExtension();
            $fileName = pathinfo($request->file('fileToUpload')->getClientOriginalName(), PATHINFO_FILENAME);
            $fileNameToStore = $fileName . '_' . time() . '.' . $fileExtension;
            $filePath = $request->file('fileToUpload')->storeAs('uploads/exercises', $fileNameToStore);

            $exercise = new Exercise();
            $exercise->title = $request->title;
            $exercise->description = $request->description;
            $exercise->file_path = 'uploads/exercises/' . $fileNameToStore;
            $exercise->save();
        }
        $data['getRecord'] = Exercise::getExercise();
        return view('admin.exercise', $data);


    }
    public function insert(Request $request)
    {
        request()->validate(['email' => 'required|email|unique:users']);
        $user = new User;
        $user->name = trim($request->name);
        $user->email = trim($request->email);
        $user->password = Hash::make($request->Password);
        $user->user_type = 2;

        $user->save();

        return redirect('admin/admin/list')->with('success', "Admin successfully created");

    }

    public function edit($id)
    {
        $data['getRecord'] = User::getSingle($id);
        if (!empty($data['getRecord'])) {
            $data['header_title'] = 'Edit Admin';
            return view('admin.admin.edit', $data);
        } else {
            abort(403);
        }
    }

    public function update($id, Request $request)
    {

        request()->validate(['email' => 'required|email|unique:users,email,' . $id]);
        $user = User::getSingle($id);
        $user->name = trim($request->name);
        $user->email = trim($request->email);
        if (!empty($request->password)) {
            $user->password = Hash::make($request->password);
        }

        $user->save();

        return redirect('admin/admin/list')->with('success', "Admin successfully updated");
    }

    public function delete($id, Request $request)
    {
        $user = User::getSingle($id);
        $user->is_delete = 1;
        $user->save();

        return redirect('admin/admin/list')->with('success', "Admin successfully deleted");
    }
    public function challenge()
    {
        $data['header_title'] = 'Create challenge';
        $data['getRecord'] = Challenge::getChallenge();
        return view('admin.challenge', $data);
    }

    public function insert_challenge(Request $request)
    {
        $data['header_title'] = 'Create challenge';
        if ($request->hasFile('fileToUpload')) {
            $fileExtension = $request->file('fileToUpload')->getClientOriginalExtension();
            $fileName = pathinfo($request->file('fileToUpload')->getClientOriginalName(), PATHINFO_FILENAME);
            $fileNameToStore = $fileName . '_' . time() . '.' . $fileExtension;
            $filePath = $request->file('fileToUpload')->storeAs('uploads/challenges', $fileNameToStore);

            $exercise = new Challenge();
            $exercise->name_challenge = $request->name_challenge;
            $exercise->question = $request->question;
            $exercise->hint = $request->hint;
            $exercise->flag = $request->flag;
            $exercise->file_path = 'uploads/challenges/' . $fileNameToStore;
            $exercise->save();
        }
        $data['getRecord'] = Challenge::getChallenge();
        return view('admin.challenge', $data);
    }

    public function delete_challenge($id)
    {
        $exercise = Challenge::find($id);
        $exercise->delete();

        return redirect()->back();
    }
    public function downloadchallenge($file_path)
    {
        $filePath = storage_path('app/' . $file_path);
        // Kiểm tra xem tệp có tồn tại không
        if (Storage::exists($file_path)) {
            // Tải tệp về và xác định tên của nó khi tải về
            return response()->download($filePath);
        } else {
            // Xử lý khi tệp không tồn tại
            return response()->json(['message' => 'Tệp không tồn tại'], 404);
        }
    }
}