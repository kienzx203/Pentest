<?php

namespace App\Http\Controllers;

use Illuminate\Support\Facades\Storage;
use App\Models\User;
use Illuminate\Http\Request;
use App\Models\Message;
use App\Models\Exercise;
use App\Models\Subexercise;
use App\Models\Challenge;

use Auth;

class StudentController extends Controller
{
    public function list()
    {
        $data['header_title'] = 'Admin List';
        $data['getRecord'] = User::getStudent();
        return view('student.list', $data);
    }
    public function profile($id)
    {
        $data['getRecord'] = User::getSingle($id);
        if (!empty($data['getRecord'])) {
            $data['header_title'] = 'Profile';
            return view('student.profile', $data);
        } else {
            abort(403);
        }
    }
    public function send_message($id)
    {
        $data['header_title'] = 'Create Message';
        $data['user_id'] = Auth::id();
        $data['id'] = $id;
        $data['getRecord'] = Message::getmessage($id);
        return view('student.createmessage', $data);

    }
    public function create_message($id, Request $request)
    {
        Message::create($request->all());
        $data['header_title'] = 'Create Message';
        $data['user_id'] = Auth::id();
        $data['id'] = $id;
        $data['getRecord'] = Message::getmessage($id);
        return view('student.createmessage', $data);
    }
    public function delete_message($id)
    {
        $message = Message::find($id);
        if (!$message) {
            return redirect()->back()->with('error', 'Tin nhắn không tồn tại');
        }

        $message->delete();

        return redirect()->back()->with('success', 'Tin nhắn đã được xóa');
    }

    public function exercise()
    {
        $data['header_title'] = 'List Exercise';
        $data['getRecord'] = Exercise::getExercise();
        return view('student.exercise', $data);
    }
    public function edit_message($id, Request $request)
    {
        $data['header_title'] = 'Edit Message';
        $data['getRecord'] = Message::getcontent($id);
        return view('student.editmessage', $data);
    }



    public function downloadexercise($file_path)
    {
        $filePath = storage_path('app/' . $file_path);
        // Kiểm tra xem tệp có tồn tại không
        if (Storage::exists($file_path)) {
            // Tải tệp về và xác định tên của nó khi tải về
            return response()->download($filePath);
        } else {
            // Xử lý khi tệp không tồn tại
            return response()->json(['message' => 'Tệp không tồn tại'], 404);
        }
    }


    public function submit_exercise($id)
    {
        $data['header_title'] = 'Submit Exercise';
        $data['getRecord'] = Subexercise::getsubmitExercise($id);
        return view('student.submitexercise', $data);
    }
    public function insert_exercise($id, Request $request)
    {
        $data['header_title'] = 'Submit Exercise';

        if ($request->hasFile('fileToUpload')) {
            $fileExtension = $request->file('fileToUpload')->getClientOriginalExtension();
            $fileName = pathinfo($request->file('fileToUpload')->getClientOriginalName(), PATHINFO_FILENAME);
            $fileNameToStore = $fileName . '_' . time() . '.' . $fileExtension;
            $filePath = $request->file('fileToUpload')->storeAs('uploads/submitexercises', $fileNameToStore);

            $exercise = new Subexercise();
            $exercise->name_student = $request->name_student;
            $exercise->id_exercise = $id;
            $exercise->id_student = Auth::id();
            $exercise->file_path = 'uploads/submitexercises/' . $fileNameToStore;
            $exercise->save();
        }
        $data['getRecord'] = Subexercise::getsubmitExercise($id);
        return view('student.submitexercise', $data);
    }

    public function update_message($id, Request $request)
    {
        $data['header_title'] = 'Update Message';
        $message = Message::find($id);
        $message->content = $request->input('content');
        $message->save();
        return redirect()->back()->with('success', 'Tin nhắn đã được up');

    }

    public function challenge()
    {
        $data['header_title'] = 'List challenge';
        $data['getRecord'] = Challenge::getChallenge();
        return view('student.challenge', $data);
    }

    public function downloadchallenge($file_path)
    {
        $filePath = storage_path('app/' . $file_path);
        // Kiểm tra xem tệp có tồn tại không
        if (Storage::exists($file_path)) {
            // Tải tệp về và xác định tên của nó khi tải về
            return response()->download($filePath);
        } else {
            // Xử lý khi tệp không tồn tại
            return response()->json(['message' => 'Tệp không tồn tại'], 404);
        }
    }


    public function submit_challenge(Request $request)
    {
        $challenge = Challenge::find($request->id);
        if ($challenge->flag == $request->flag) {
            return response()->json(['message' => 'Correct']);
        } else {
            return response()->json(['message' => 'Incorrect']);
        }



    }
}